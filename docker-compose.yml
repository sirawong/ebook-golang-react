version: "3.9"
services:
    nginx:
        image: siraphopdocker/ebook-nginx:latest
        container_name: nginx
        restart: always
        depends_on:
            - frontend
            - user
            - book
            - cart
        ports:
            - 80:80

    frontend:
        image: siraphopdocker/ebook-frontend:latest
        container_name: client
        environment:
            - CHOKIDAR_USEPOLLING=true

    redis:
        image: redis:alpine
        command: redis-server --requirepass ${REDIS_PASSWORD}
        container_name: redis
        volumes: 
            - ./redis-vol:/data

    user:
        image: siraphopdocker/ebook-user:latest
        container_name: user
        depends_on:
            - redis
        environment:
            - APP_USER_PORT=${APP_USER_PORT}
            - DB_DB_URI=${DB_DB_URI}
            - DB_CLDNAME=${DB_CLDNAME}
            - DB_CLDAPI=${DB_CLDAPI}
            - DB_CLDSECRET=${DB_CLDSECRET}
            - TOKEN_ACCESS_TOKEN=${TOKEN_ACCESS_TOKEN}
            - TOKEN_REFRESH_TOKEN=${TOKEN_REFRESH_TOKEN}
            - REDIS_DSN=${REDIS_DSN}
            - REDIS_PASSWORD=${REDIS_PASSWORD}

    books:
        image: siraphopdocker/ebook-book:latest
        container_name: books
        depends_on:
            - user
        environment:
            - APP_BOOK_PORT=${APP_BOOK_PORT}
            - DB_DB_URI=${DB_DB_URI}
            - DB_CLDNAME=${DB_CLDNAME}
            - DB_CLDAPI=${DB_CLDAPI}
            - DB_CLDSECRET=${DB_CLDSECRET}
            - AUTH_URI_BOOK=${AUTH_URI_BOOK}

    cart:
        image: siraphopdocker/ebook-cart:latest
        container_name: cart
        depends_on:
            - user
        environment:
            - APP_CART_PORT=${APP_CART_PORT}
            - DB_DB_URI=${DB_DB_URI}
            - AUTH_URI_CART=${AUTH_URI_CART}